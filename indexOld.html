<!DOCTYPE html>
<html>

<head>
        <title>FINAL PROJECT - Geovis</title>
        <h1> Interactive Map using D3 </h1>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- styleSheets -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
        <link rel="stylesheet" href="stylesheet.css" />
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <style>
                body {
                        padding: 0;
                        margin: 0;
                }

                html,
                body,
                #map {
                        height: 100%;
                        font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
                }

                .lorem {
                        font-style: italic;
                        color: #AAA;
                }
        </style>
</head>

<body>

        <script type="text/javascript">
                /*  This visualization was made possible by modifying code provided by:
                
                Scott Murray, Choropleth example from "Interactive Data Visualization for the Web" 
                https://github.com/alignedleft/d3-book/blob/master/chapter_12/05_choropleth.html   
                                
                Malcolm Maclean, tooltips example tutorial
                http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html
                
                Mike Bostock, Pie Chart Legend
                http://bl.ocks.org/mbostock/3888852
                
                Michelle Chandra, Choropleth example and the framework of the code
                 http://bl.ocks.org/michellechandra/0b2ce4923dc9b5809922 */


                //Width and height of map
                var width = 864;
                var height = 450;

                // D3 Projection
                var projection = d3.geoAlbersUsa()
                        .translate([width / 2, height / 2])    // translate to center of screen
                        .scale([1000]);          // scale things down so see entire US

                // Define path generator
                var path = d3.geoPath()               // path generator that will convert GeoJSON to SVG paths
                        .projection(projection);  // tell path generator to use albersUsa projection


                // Define linear scale for output
                //var color = d3.scaleLinear()
                //        .range(["rgb(213,222,217)", "rgb(69,173,168)", "rgb(84,36,55)", "rgb(217,91,67)"]);
                //TODO:figure out how to make a gradiant maybe using https://github.com/d3/d3-scale-chromatic
                //values are given around line 121 where the color value is assigned based on the value in 
                //stateslived.csv under "visited"
                var legendText = ["Cities Lived", "States Lived", "States Visited", "Nada"];

                //Create SVG element and append map to the SVG
                var svg = d3.select("body")
                        .append("svg")
                        .attr("width", width)
                        .attr("height", height);

                var svg2 = d3.select("body")
                        .append("svg")
                        .attr("x", 450)
                        .attr("y", 0)
                        .attr("width", width)
                        .attr("height", height)

                //this whole part should be a function that takes two .csv names or column names
                //depending on which method we go with and develop two maps depending on those
                //variables. I could make it work now, but all it would be doing is copy/pasting
                //the next 60 lines which wouldnt be helpful to anyone.

                // Append Div for tooltip to SVG
                var div = d3.select("body")
                        .append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0);

                // Load in my states data!
                var svgArray = [svg, svg2]

                d3.csv("ObesityTotalByStateAndYear.csv", function (data) {
                        //color.domain([0, 1, 2, 3]); // setting the range of the input data


                        // this will need to be adjusted to add all of the data from the csv ***
                        // Load GeoJSON data and merge with states data
                        d3.json("us-states.json", function (json) {

                                // Loop through each state data value in the .csv file
                                var maxRate = 0;
                                var minRate = 100;
                                for (var i = 0; i < data.length; i++) {

                                        // Grab State Name
                                        var dataState = data[i].LocationDesc;

                                        // Grab data value 
                                        var years = "2011"
                                        var dataValue = data[i].years;
                                        if (dataValue > maxRate && dataValue!="DNE") {
                                                maxRate = dataValue
                                        }

                                        if (dataValue < minRate && dataValue!="DNE") {
                                                minRate = dataValue
                                        }
                                        // Find the corresponding state inside the GeoJSON
                                        for (var j = 0; j < json.features.length; j++) {
                                                var jsonState = json.features[j].properties.name;

                                                if (dataState == jsonState) {

                                                        // Copy the data value into the JSON
                                                        json.features[j].properties.year = dataValue;


                                                        // Stop looking through the JSON
                                                        break;
                                                }
                                        }
                                }
                                for (var k = 0; k < svgArray.length; k++) {
                                        mapAffected = svgArray[k]
                                        // Bind the data to the SVG and create one path per GeoJSON feature
                                        mapAffected.selectAll("path")
                                                .data(json.features)
                                                .enter()
                                                .append("path")
                                                .attr("d", path)
                                                .style("stroke", "#fff")
                                                .style("stroke-width", "1")
                                                .style("fill", function (d) {

                                                        // Get data value
                                                        var value = d.properties.year;

                                                        if (value === "DNE") {
                                                                //If value exists…
                                                                //If value is undefined…
                                                                return "black";


                                                        } else {
                                                                //color = d3.interpolateBlues(value / (maxRate / 100))
                                                                var color = d3.scaleLinear().domain([minRate-5,maxRate]).range(["white","steelblue"])
                                                                var color1 =  color(value)
                                                                return color1;
                                                        }
                                                })
                                        mapAffected.selectAll("path")
                                                // Modification of custom tooltip code provided by Malcolm Maclean, "D3 Tips and Tricks" 
                                                // http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html
                                                .on("mouseover", function (d) {
                                                        div.transition()
                                                                .duration(200)
                                                                .style("opacity", .9);
                                                        div.text(d.properties.year + "% of the population in " + d.properties.name + " is obese.")
                                                                .style("left", (d3.event.pageX) + "px")
                                                                .style("top", (d3.event.pageY - 28) + "px");
                                                })

                                                // fade out tooltip on mouse out               
                                                .on("mouseout", function (d) {
                                                        div.transition()
                                                                .duration(500)
                                                                .style("opacity", 0);
                                                });

                                }
                                // Modified Legend Code from Mike Bostock: http://bl.ocks.org/mbostock/3888852
                                var legend = d3.select("body").append("svg")
                                        .attr("class", "legend")
                                        .attr("width", 140)
                                        .attr("height", 200)
                                        .selectAll("g")
                                        .enter()
                                        .append("g")
                                        .attr("transform", function (d, i) { return "translate(0," + i * 20 + ")"; });

                                legend.append("rect")
                                        .attr("width", 18)
                                        .attr("height", 18)
                                        .style("fill", color);

                                legend.append("text")
                                        .data(legendText)
                                        .attr("x", 24)
                                        .attr("y", 9)
                                        .attr("dy", ".35em")
                                        .text(function (d) { return d; });
                        });
                });
        </script>
        <p> My first D3 map shows Michelle Chandra's travel across the US. </p>
        <p> This visualization was built by modifying
                <a href="http://bl.ocks.org/michellechandra/0b2ce4923dc9b5809922"> Michelle Chandra's Basic US State Map - D3.</a>
        </p>

</html>

</body>

</html>